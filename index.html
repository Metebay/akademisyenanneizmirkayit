<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Akademisyen Anne İzmir Anaokulu - Kayıt</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            -webkit-tap-highlight-color: transparent;
            background-color: #f8fafc;
        }
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* ÖZEL RENK AYARLARI (#7cc939) */
        :root {
            --primary: #7cc939; 
            --primary-hover: #6db333;
            --primary-light: #f0fdf4; /* Çok açık yeşil */
            --primary-border: #dcfce7;
        }
        
        .bg-custom { background-color: var(--primary); }
        .bg-custom-hover:hover { background-color: var(--primary-hover); }
        .text-custom { color: var(--primary); }
        .border-custom { border-color: var(--primary); }
        .ring-custom { --tw-ring-color: var(--primary); }
        .bg-custom-light { background-color: var(--primary-light); }

        /* Mobil Input Zoom Engelleme ve Modern Input Stili */
        input, select, textarea { 
            font-size: 16px !important; 
            transition: all 0.2s ease;
        }
        input:focus, select:focus, textarea:focus {
            transform: translateY(-1px);
        }
        
        /* Buton Efektleri */
        button:active { transform: scale(0.98); }
    </style>
</head>
<body class="text-slate-800 min-h-screen flex flex-col selection:bg-custom selection:text-white">

    <!-- Navbar (Glassmorphism Effect) -->
    <nav class="bg-white/90 backdrop-blur-md border-b border-slate-200/60 sticky top-0 z-50">
        <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-20 items-center">
                <div class="flex items-center gap-3 cursor-pointer group" onclick="router('home')">
                    <div class="w-11 h-11 bg-custom rounded-xl flex items-center justify-center text-white shadow-lg shadow-green-200 group-hover:scale-105 transition-transform">
                        <i data-lucide="graduation-cap" class="w-6 h-6"></i>
                    </div>
                    <div>
                        <h1 class="text-lg font-extrabold text-slate-900 leading-tight tracking-tight">Akademisyen Anne</h1>
                        <p class="text-[11px] text-custom font-bold tracking-widest uppercase">İzmir Anaokulu</p>
                    </div>
                </div>
                
                <a href="admin.html" class="text-slate-400 hover:text-custom p-2 bg-slate-50 hover:bg-green-50 rounded-lg transition-colors">
                    <i data-lucide="lock" class="w-5 h-5"></i>
                </a>
            </div>
        </div>
    </nav>

    <main class="flex-1 max-w-5xl mx-auto w-full px-4 sm:px-6 lg:px-8 py-8 relative">
        
        <!-- View: Home -->
        <div id="view-home" class="view-section fade-in">
            <div class="flex flex-col items-center justify-center py-10 text-center space-y-8">
                
                <!-- Hero Section -->
                <div class="space-y-6 max-w-3xl">
                    <div class="inline-flex items-center gap-2 bg-green-50 text-custom px-4 py-2 rounded-full text-xs font-bold border border-green-100 shadow-sm animate-bounce">
                        <i data-lucide="calendar" class="w-4 h-4"></i> 2026-2027 Erken Kayıt Dönemi
                    </div>
                    <h2 class="text-4xl md:text-6xl font-extrabold text-slate-900 tracking-tight leading-[1.15]">
                        Geleceğin Akademisyenleri <br/>
                        <span class="text-custom relative">
                            Burada Yetişiyor
                            <svg class="absolute w-full h-3 -bottom-1 left-0 text-green-200 -z-10" viewBox="0 0 100 10" preserveAspectRatio="none"><path d="M0 5 Q 50 10 100 5" stroke="currentColor" stroke-width="8" fill="none" /></svg>
                        </span>
                    </h2>
                    <p class="text-lg text-slate-600 max-w-2xl mx-auto leading-relaxed">
                        Akademisyen Anne İzmir Anaokulu olarak çocuklarımıza bilimsel temelli, sevgi dolu ve güvenli bir eğitim ortamı sunuyoruz.
                    </p>
                </div>
                
                <button onclick="router('booking')" class="group relative w-full sm:w-auto bg-custom hover:bg-[#6db333] text-white font-bold py-4 px-12 rounded-2xl shadow-xl shadow-green-200 transition-all flex items-center justify-center gap-3 text-lg overflow-hidden">
                    <div class="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300"></div>
                    <i data-lucide="calendar-check" class="w-6 h-6 relative z-10"></i>
                    <span class="relative z-10">Randevu Oluştur</span>
                </button>
                
                <!-- Features Grid -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-5 mt-16 w-full text-left">
                    <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm hover:shadow-md hover:border-green-200 transition-all group">
                        <div class="mb-4 w-12 h-12 rounded-xl bg-green-50 flex items-center justify-center text-custom group-hover:bg-custom group-hover:text-white transition-colors">
                            <i data-lucide="graduation-cap" class="w-6 h-6"></i>
                        </div>
                        <h3 class="text-lg font-bold text-slate-900 mb-2">Akademik Eğitim</h3>
                        <p class="text-slate-500 text-sm leading-relaxed">Bilimsel temelli modern eğitim modelleri ile çocuk gelişimi.</p>
                    </div>
                    <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm hover:shadow-md hover:border-green-200 transition-all group">
                        <div class="mb-4 w-12 h-12 rounded-xl bg-blue-50 flex items-center justify-center text-blue-600 group-hover:bg-blue-600 group-hover:text-white transition-colors">
                            <i data-lucide="check-circle" class="w-6 h-6"></i>
                        </div>
                        <h3 class="text-lg font-bold text-slate-900 mb-2">Kolay Kayıt</h3>
                        <p class="text-slate-500 text-sm leading-relaxed">Hızlı ve pratik online randevu sistemi ile zaman kazanın.</p>
                    </div>
                    <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm hover:shadow-md hover:border-green-200 transition-all group">
                        <div class="mb-4 w-12 h-12 rounded-xl bg-orange-50 flex items-center justify-center text-orange-600 group-hover:bg-orange-600 group-hover:text-white transition-colors">
                            <i data-lucide="shield" class="w-6 h-6"></i>
                        </div>
                        <h3 class="text-lg font-bold text-slate-900 mb-2">Güvenli Ortam</h3>
                        <p class="text-slate-500 text-sm leading-relaxed">Çocuklarınızın güvenliği için tasarlanmış modern alanlar.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- View: Booking -->
        <div id="view-booking" class="view-section hidden fade-in">
            <div class="bg-white rounded-3xl shadow-xl shadow-slate-200/50 border border-slate-100 overflow-hidden max-w-3xl mx-auto mb-24">
                
                <!-- Header -->
                <div class="bg-slate-900 p-6 text-white flex justify-between items-center relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-64 h-64 bg-custom opacity-10 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2"></div>
                    <h3 class="text-xl font-bold flex items-center gap-3 relative z-10">
                        <span class="bg-white/10 p-2 rounded-lg"><i data-lucide="calendar"></i></span>
                        Randevu Formu
                    </h3>
                    <button onclick="router('home')" class="bg-white/10 hover:bg-white/20 p-2 rounded-full transition-colors relative z-10"><i data-lucide="x" class="w-5 h-5"></i></button>
                </div>
                
                <div class="p-6 md:p-10" id="booking-container">
                    <!-- Progress Bar -->
                    <div class="relative mb-10">
                        <div class="absolute top-1/2 left-0 w-full h-1 bg-slate-100 rounded-full -translate-y-1/2"></div>
                        <div class="relative flex justify-between text-xs font-bold text-slate-400">
                            <div class="flex flex-col items-center gap-2 step-1-ind transition-colors duration-300">
                                <span class="w-8 h-8 rounded-full flex items-center justify-center border-2 border-custom bg-white text-custom shadow-sm z-10">1</span>
                                <span class="text-custom">Zaman</span>
                            </div>
                            <div class="flex flex-col items-center gap-2 step-2-ind transition-colors duration-300">
                                <span class="w-8 h-8 rounded-full flex items-center justify-center border-2 border-slate-200 bg-white z-10">2</span>
                                <span>Veli</span>
                            </div>
                            <div class="flex flex-col items-center gap-2 step-3-ind transition-colors duration-300">
                                <span class="w-8 h-8 rounded-full flex items-center justify-center border-2 border-slate-200 bg-white z-10">3</span>
                                <span>Öğrenci</span>
                            </div>
                        </div>
                    </div>

                    <!-- Step 1: Date/Time -->
                    <div id="step-1">
                        <h4 class="font-bold text-lg text-slate-800 mb-4 flex items-center gap-2">
                            <i data-lucide="calendar-days" class="w-5 h-5 text-custom"></i> Tarih Seçin
                        </h4>
                        <div id="date-grid" class="grid grid-cols-2 sm:grid-cols-3 gap-3 mb-8">
                            <div class="col-span-full text-center text-slate-400 py-8 bg-slate-50 rounded-xl animate-pulse">Takvim yükleniyor...</div>
                        </div>

                        <div id="time-section" class="hidden animate-fadeIn pb-16">
                            <h4 class="font-bold text-lg text-slate-800 mb-4 flex items-center gap-2 border-t border-slate-100 pt-8">
                                <i data-lucide="clock" class="w-5 h-5 text-custom"></i> Saat Seçin
                                <span id="custom-hours-badge" class="hidden text-[10px] bg-yellow-100 text-yellow-700 px-2 py-1 rounded-md ml-auto font-bold uppercase tracking-wider border border-yellow-200">Özel Saat</span>
                            </h4>
                            <div id="time-grid" class="grid grid-cols-3 sm:grid-cols-4 gap-3 max-h-64 overflow-y-auto pr-2 custom-scrollbar">
                                <!-- JS ile doldurulacak -->
                            </div>
                        </div>
                        
                        <!-- Mobile Sticky Button -->
                        <div class="fixed bottom-0 left-0 w-full bg-white/90 backdrop-blur-md border-t border-slate-200 p-4 md:static md:bg-transparent md:border-0 md:p-0 md:pt-6 z-40">
                            <button id="btn-step-1-next" onclick="nextStep(2)" disabled class="w-full bg-custom hover:bg-[#6db333] text-white py-4 md:py-3.5 rounded-xl font-bold disabled:opacity-50 disabled:cursor-not-allowed shadow-lg shadow-green-200 transition-all text-lg md:text-base flex items-center justify-center gap-2">
                                Devam Et <i data-lucide="arrow-right" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Step 2: Parent Info -->
                    <div id="step-2" class="hidden pb-20">
                        <h4 class="font-bold text-xl text-slate-800 border-b border-slate-100 pb-4 mb-6">Veli Bilgileri</h4>
                        <div class="space-y-5">
                            <div>
                                <label class="text-xs font-bold text-slate-500 uppercase mb-1.5 block ml-1">Veli Adı Soyadı</label>
                                <div class="relative">
                                    <i data-lucide="user" class="absolute left-4 top-4 text-slate-400 w-5 h-5"></i>
                                    <input type="text" id="inp-parentName" class="w-full pl-12 p-4 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 ring-custom focus:bg-white focus:border-custom outline-none transition-all placeholder:text-slate-400" placeholder="Örn: Ahmet Yılmaz">
                                </div>
                            </div>
                            <div>
                                <label class="text-xs font-bold text-slate-500 uppercase mb-1.5 block ml-1">Telefon Numarası</label>
                                <div class="relative">
                                    <i data-lucide="phone" class="absolute left-4 top-4 text-slate-400 w-5 h-5"></i>
                                    <input type="tel" id="inp-phone" class="w-full pl-12 p-4 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 ring-custom focus:bg-white focus:border-custom outline-none transition-all placeholder:text-slate-400" placeholder="05XX XXX XX XX">
                                </div>
                            </div>
                            <div>
                                <label class="text-xs font-bold text-slate-500 uppercase mb-1.5 block ml-1">E-Posta Adresi</label>
                                <div class="relative">
                                    <i data-lucide="mail" class="absolute left-4 top-4 text-slate-400 w-5 h-5"></i>
                                    <input type="email" id="inp-email" class="w-full pl-12 p-4 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 ring-custom focus:bg-white focus:border-custom outline-none transition-all placeholder:text-slate-400" placeholder="ornek@mail.com">
                                </div>
                            </div>
                        </div>
                        
                        <div class="fixed bottom-0 left-0 w-full bg-white/90 backdrop-blur-md border-t border-slate-200 p-4 md:static md:bg-transparent md:border-0 md:p-0 md:pt-8 flex gap-3 z-40">
                            <button onclick="prevStep(1)" class="flex-1 md:flex-none text-slate-500 hover:text-slate-800 font-bold px-6 py-3.5 bg-slate-100 hover:bg-slate-200 rounded-xl transition-colors">Geri</button>
                            <button onclick="nextStep(3)" class="flex-[2] md:flex-none bg-custom hover:bg-[#6db333] text-white px-8 py-3.5 rounded-xl font-bold shadow-lg shadow-green-200 flex items-center justify-center gap-2">
                                Devam Et <i data-lucide="arrow-right" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Step 3: Student Info -->
                    <div id="step-3" class="hidden pb-20">
                        <h4 class="font-bold text-xl text-slate-800 border-b border-slate-100 pb-4 mb-6">Öğrenci Bilgileri</h4>
                        <div class="space-y-5">
                            <div>
                                <label class="text-xs font-bold text-slate-500 uppercase mb-1.5 block ml-1">Öğrenci Adı Soyadı</label>
                                <div class="relative">
                                    <i data-lucide="baby" class="absolute left-4 top-4 text-slate-400 w-5 h-5"></i>
                                    <input type="text" id="inp-childName" class="w-full pl-12 p-4 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 ring-custom focus:bg-white focus:border-custom outline-none transition-all" placeholder="Örn: Ayşe Yılmaz">
                                </div>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-5">
                                <div>
                                    <label class="text-xs font-bold text-slate-500 uppercase mb-1.5 block ml-1">Doğum Tarihi</label>
                                    <input type="date" id="inp-childBirthDate" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 ring-custom focus:bg-white focus:border-custom outline-none transition-all text-slate-600">
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-500 uppercase mb-1.5 block ml-1">Cinsiyet</label>
                                    <div class="relative">
                                        <select id="inp-gender" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 ring-custom focus:bg-white focus:border-custom outline-none transition-all appearance-none text-slate-600">
                                            <option value="Belirtilmedi">Seçiniz</option>
                                            <option value="Kız">Kız</option>
                                            <option value="Erkek">Erkek</option>
                                        </select>
                                        <i data-lucide="chevron-down" class="absolute right-4 top-4 text-slate-400 w-5 h-5 pointer-events-none"></i>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label class="text-xs font-bold text-slate-500 uppercase mb-1.5 block ml-1">Notlar / Özel Durumlar</label>
                                <textarea id="inp-notes" placeholder="Varsa eklemek istedikleriniz..." class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 ring-custom focus:bg-white focus:border-custom outline-none transition-all" rows="3"></textarea>
                            </div>
                        </div>

                        <div class="fixed bottom-0 left-0 w-full bg-white/90 backdrop-blur-md border-t border-slate-200 p-4 md:static md:bg-transparent md:border-0 md:p-0 md:pt-8 flex gap-3 z-40">
                            <button onclick="prevStep(2)" class="flex-1 md:flex-none text-slate-500 hover:text-slate-800 font-bold px-6 py-3.5 bg-slate-100 hover:bg-slate-200 rounded-xl transition-colors">Geri</button>
                            <button onclick="submitBooking()" id="btn-submit" class="flex-[2] md:flex-none bg-custom hover:bg-[#6db333] text-white px-8 py-3.5 rounded-xl font-bold shadow-lg shadow-green-200 flex justify-center items-center gap-2">
                                Randevuyu Tamamla <i data-lucide="check-circle" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Toast Notification -->
    <div id="notification" class="fixed top-4 left-1/2 -translate-x-1/2 px-6 py-3 rounded-full shadow-2xl text-white transform transition-all duration-300 z-[60] -translate-y-24 opacity-0 text-sm font-bold whitespace-nowrap flex items-center gap-2 backdrop-blur-sm"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, doc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC-NozhF3X1NgX4ZSaXHMTR2n0vCoZbstY",
            authDomain: "anaokulu-e728c.firebaseapp.com",
            projectId: "anaokulu-e728c",
            storageBucket: "anaokulu-e728c.firebasestorage.app",
            messagingSenderId: "722320031337",
            appId: "1:722320031337:web:cfaaa2bc2ae22e0fd0acf8",
            measurementId: "G-L9V6S50C89"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'anaokulu-yonetim';

        let globalSettings = { start: "09:00", end: "17:00", interval: "30", blockedDates: [], customSchedules: {} };
        let appointments = [];
        let bookingData = { date: '', time: '' };

        // --- YEREL SAAT FORMATLAYICI ---
        const formatDateLocal = (date) => {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        const showToast = (msg, type = 'success') => {
            const el = document.getElementById('notification');
            el.className = `fixed top-4 left-1/2 -translate-x-1/2 px-6 py-3 rounded-full shadow-2xl text-white transform transition-all duration-300 z-[60] text-sm font-bold whitespace-nowrap flex items-center gap-2 backdrop-blur-sm ${type === 'error' ? 'bg-red-500/90' : 'bg-green-500/90'}`;
            el.innerHTML = type === 'error' ? `<i data-lucide="alert-circle" class="w-4 h-4"></i> ${msg}` : `<i data-lucide="check" class="w-4 h-4"></i> ${msg}`;
            el.classList.remove('-translate-y-24', 'opacity-0');
            lucide.createIcons();
            setTimeout(() => el.classList.add('-translate-y-24', 'opacity-0'), 3000);
        };

        window.router = (viewName) => {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${viewName}`).classList.remove('hidden');
            if(viewName === 'booking') {
                window.scrollTo(0,0);
                renderDateButtons(); 
            }
            lucide.createIcons();
        };

        window.nextStep = (step) => {
            if(step === 2 && (!bookingData.date || !bookingData.time)) {
                return showToast('Lütfen önce tarih ve saat seçiniz.', 'error');
            }

            document.querySelectorAll('[id^="step-"]').forEach(el => el.classList.add('hidden'));
            document.getElementById(`step-${step}`).classList.remove('hidden');
            
            window.scrollTo(0,0);

            // Progress Indicator Update
            if(step === 2) {
                const ind2 = document.querySelector('.step-2-ind');
                ind2.querySelector('span:first-child').className = "w-8 h-8 rounded-full flex items-center justify-center border-2 border-custom bg-white text-custom shadow-sm z-10 transition-all";
                ind2.querySelector('span:last-child').classList.add('text-custom');
            }
            if(step === 3) {
                const ind3 = document.querySelector('.step-3-ind');
                ind3.querySelector('span:first-child').className = "w-8 h-8 rounded-full flex items-center justify-center border-2 border-custom bg-white text-custom shadow-sm z-10 transition-all";
                ind3.querySelector('span:last-child').classList.add('text-custom');
            }
        };

        window.prevStep = (step) => {
            document.querySelectorAll('[id^="step-"]').forEach(el => el.classList.add('hidden'));
            document.getElementById(`step-${step}`).classList.remove('hidden');
            window.scrollTo(0,0);
        };

        window.selectDate = (dateStr) => {
            bookingData.date = dateStr;
            bookingData.time = ''; 
            
            // Buton reset
            const nextBtn = document.getElementById('btn-step-1-next');
            if(nextBtn) { nextBtn.disabled = true; nextBtn.classList.add('opacity-50', 'cursor-not-allowed'); }

            document.querySelectorAll('.date-btn').forEach(btn => {
                btn.className = `date-btn flex flex-col items-center justify-center p-2 rounded-2xl border-2 transition-all h-24 relative overflow-hidden bg-white border-slate-100 text-slate-500 hover:border-green-200 active:scale-95 shadow-sm`;
            });
            const selectedBtn = document.querySelector(`button[data-date="${dateStr}"]`);
            if(selectedBtn) {
                selectedBtn.className = `date-btn flex flex-col items-center justify-center p-2 rounded-2xl border-2 transition-all h-24 relative overflow-hidden bg-green-50/50 border-custom text-custom ring-1 ring-custom shadow-md transform scale-[1.02]`;
            }
            renderTimeSlots();
        };

        window.selectTime = (timeStr) => {
            bookingData.time = timeStr;
            document.querySelectorAll('.time-btn').forEach(btn => {
                btn.className = `time-btn p-3 rounded-xl font-bold border transition-all text-center bg-white border-slate-200 text-slate-600 hover:border-green-300 active:scale-95`;
            });
            const selectedBtn = document.querySelector(`button[data-time="${timeStr}"]`);
            if(selectedBtn) {
                selectedBtn.className = `time-btn p-3 rounded-xl font-bold border transition-all text-center bg-custom text-white border-transparent shadow-lg shadow-green-200 transform scale-105`;
            }
            // Enable Next Button
            const nextBtn = document.getElementById('btn-step-1-next');
            if(nextBtn) { nextBtn.disabled = false; nextBtn.classList.remove('opacity-50', 'cursor-not-allowed'); }
        };

        window.submitBooking = async () => {
            const btn = document.getElementById('btn-submit');
            const pName = document.getElementById('inp-parentName').value;
            const phone = document.getElementById('inp-phone').value;
            if(!pName || !phone) return showToast('Lütfen Veli Adı ve Telefon giriniz.', 'error');

            btn.disabled = true;
            btn.innerHTML = '<i data-lucide="loader-2" class="w-5 h-5 animate-spin"></i> İşleniyor...';
            lucide.createIcons();

            const data = {
                ...bookingData,
                parentName: pName,
                phone: phone,
                email: document.getElementById('inp-email').value,
                childName: document.getElementById('inp-childName').value,
                childBirthDate: document.getElementById('inp-childBirthDate').value,
                gender: document.getElementById('inp-gender').value,
                notes: document.getElementById('inp-notes').value,
                createdAt: new Date().toISOString(),
                status: 'pending'
            };

            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'appointments'), data);
                showToast('Randevunuz Başarıyla Oluşturuldu!');
                setTimeout(() => location.reload(), 2500);
            } catch (e) {
                console.error(e);
                showToast('Bir hata oluştu, lütfen tekrar deneyin.', 'error');
                btn.disabled = false;
                btn.innerHTML = 'Randevuyu Tamamla <i data-lucide="check-circle" class="w-5 h-5"></i>';
                lucide.createIcons();
            }
        };

        function renderDateButtons() {
            const grid = document.getElementById('date-grid');
            if(!grid) return;
            grid.innerHTML = '';
            const today = new Date();
            
            for (let i = 0; i < 6; i++) {
                const d = new Date(today);
                d.setDate(today.getDate() + i);
                
                const dateStr = formatDateLocal(d);
                const dayNum = d.getDate();
                const month = d.toLocaleDateString('tr-TR', { month: 'short' });
                const dayName = d.toLocaleDateString('tr-TR', { weekday: 'long' });
                
                const isBlocked = globalSettings.blockedDates.includes(dateStr);
                const hasCustom = globalSettings.customSchedules[dateStr];

                const btn = document.createElement('button');
                btn.dataset.date = dateStr;
                btn.disabled = isBlocked;
                
                let btnClass = `date-btn flex flex-col items-center justify-center p-2 rounded-2xl border-2 transition-all h-24 relative overflow-hidden `;
                if(isBlocked) btnClass += 'bg-slate-50 border-slate-100 text-slate-300 cursor-not-allowed opacity-70';
                else btnClass += 'bg-white border-slate-100 text-slate-500 hover:border-green-200 active:scale-95 shadow-sm';
                
                btn.className = btnClass;
                
                if (!isBlocked && hasCustom) {
                    btn.innerHTML += `<div class="absolute top-0 right-0 bg-orange-400 text-white text-[9px] px-2 py-0.5 rounded-bl-lg font-bold shadow-sm">ÖZEL</div>`;
                }

                const label = isBlocked ? 'DOLU' : dayName;
                btn.innerHTML += `
                    <span class="text-[10px] font-bold uppercase mb-1 tracking-wide ${isBlocked ? '' : 'text-slate-400'}">${label}</span>
                    <span class="text-xl font-extrabold leading-none tracking-tight">${dayNum} ${month}</span>
                `;
                btn.onclick = () => selectDate(dateStr);
                grid.appendChild(btn);
            }
        }

        function renderTimeSlots() {
            const container = document.getElementById('time-section');
            const grid = document.getElementById('time-grid');
            const badge = document.getElementById('custom-hours-badge');
            container.classList.remove('hidden');
            grid.innerHTML = '';

            let start = globalSettings.start;
            let end = globalSettings.end;
            
            if (globalSettings.customSchedules[bookingData.date]) {
                const custom = globalSettings.customSchedules[bookingData.date];
                start = custom.start;
                end = custom.end;
                badge.textContent = `${start}-${end}`;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }

            const slots = [];
            let [sH, sM] = start.split(':').map(Number);
            let [eH, eM] = end.split(':').map(Number);
            let current = new Date(); current.setHours(sH, sM, 0, 0);
            let endTime = new Date(); endTime.setHours(eH, eM, 0, 0);

            while (current < endTime) {
                slots.push(current.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit', hour12: false }));
                current.setMinutes(current.getMinutes() + parseInt(globalSettings.interval));
            }

            slots.forEach(slot => {
                const isTaken = appointments.some(a => a.date === bookingData.date && a.time === slot);
                const btn = document.createElement('button');
                btn.dataset.time = slot;
                btn.disabled = isTaken;
                btn.textContent = slot;
                
                let btnClass = `time-btn p-3 rounded-xl font-bold border transition-all text-center `;
                if(isTaken) btnClass += 'bg-slate-50 text-slate-300 border-slate-100 cursor-not-allowed line-through decoration-slate-300';
                else btnClass += 'bg-white border-slate-200 text-slate-600 hover:border-green-300 active:scale-95';
                
                btn.className = btnClass;
                btn.onclick = () => selectTime(slot);
                grid.appendChild(btn);
            });
        }

        onAuthStateChanged(auth, (user) => {
            if (!user) {
                signInAnonymously(auth).catch(console.error);
            } else {
                onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'config'), (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        globalSettings = { 
                            ...data, 
                            blockedDates: data.blockedDates || [], 
                            customSchedules: data.customSchedules || {} 
                        };
                        renderDateButtons();
                    } else {
                        renderDateButtons(); 
                    }
                });
                onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'appointments')), (snap) => {
                    appointments = snap.docs.map(d => d.data());
                    if(bookingData.date) renderTimeSlots();
                });
            }
        });

        lucide.createIcons();
    </script>
</body>
</html>
